<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link as=font crossorigin href=https://e792a8.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://e792a8.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 rel=preload type=font/woff2><link href=https://e792a8.github.io/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>Linux Subsystem for Windows | empty</title><meta name=description><link href=https://e792a8.github.io/posts/2024/09/68bc3acc/ rel=canonical><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://e792a8.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Posts",
            "item": "https://e792a8.github.io/posts/"
          },
        
      
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "2024",
            "item": "https://e792a8.github.io/posts/2024/"
          },
        
      
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  4 ,
            "name": "09",
            "item": "https://e792a8.github.io/posts/2024/09/"
          },
        
      
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  5 ,
            "name": "68bc3acc",
            "item": "https://e792a8.github.io/posts/2024/09/68bc3acc/"
          },
        
      
    
  }
</script><meta content=#fff name=theme-color><link href=https://e792a8.github.io/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://e792a8.github.io/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://e792a8.github.io/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link crossorigin href=https://e792a8.github.io/site.webmanifest rel=manifest><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq rel=stylesheet><script crossorigin defer integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script crossorigin defer integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://e792a8.github.io>empty</a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/e792a8><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://e792a8.github.io/></a></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input aria-label="Search docs..." class="form-control is-search" placeholder="Search docs..." autocomplete=off id=userinput type=search><div class="shadow bg-white rounded" id=suggestions></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xxl-8"><article><div class=blog-header><h1>Linux Subsystem for Windows</h1><p><small>Posted 2024-09-17 ‐ <strong>6 min read</strong></small><p></div><ol><li><p>场景：你受够了m$，决定投奔linux阵营。</p> <p>但是C盘的陈年老$hit还舍不得扔，所以你选择了双。</p> <p>且预算不支持你单独搞块SSD，所以你让linux和$hit挤在一块盘的两个分区里。</p> <p>你又觉得重启切系统很麻烦，蓝牙键鼠和WiFi还会掉，所以你决定给WSL来个倒反天罡。 <span id=continue-reading></span></p> <p>你开始思考要怎么把物理盘上的$hit搞到虚拟机里，直接把整个物理盘挂上去似乎不太安全。</p> <p>你决定只把$hit的分区搞进去，但麻烦的是这玩意只是个裸分区，没法引导。</p> <p>所以还是得有个完整的盘，带分区表和efi分区的，要带上物理盘的一个分区，还不能影响物理盘的其他地方。</p><li><p>准备：虚拟机，理论上啥都行，我用的是virt-manager和qemu/kvm。</p> <p>Windows安装盘，有个iso镜像就行，我们只需要用这玩意修引导，如果你嫌大并且有别的修引导工具比如PE的话应该也行。</p> <p>修分区工具testdisk，最好备一个手动分区工具，我喜欢fdisk。</p> <p>确认dmsetup，losetup正常。</p> <p>确认Windows能用长密码登陆，进虚拟机PIN之类的用不了。</p><li><p>我的工作目录是<code>/var/lib/private</code>，查资料确认有没有别的用途，没查到，看名字应该是咱能自己随便用的意思。</p> <p>我的$hit分区是<code>/dev/nvme0n1p3</code>或者<code>/dev/disk/by-uuid/122831BB28319EA3</code>。</p><li><p>搞个windisk-begin.img，等下用来粘在前面，256MiB应该够了。</p> <p>再搞个windisk-end.img，等下用来粘在后面，64MiB应该远远够了，不确定是否必要，但是fdisk好像喜欢在盘末尾留一点空间。</p> <p>dd两下很快。</p><li><p>因为diskmapper只支持粘块设备，不支持粘文件，所以把上面两个文件搞成loop设备。</p> <p>先搞两个inode。major我看别的loop都是7。minor我寻思尽量大点好吧。</p> <pre class=z-code><code><span class="z-text z-plain">mknod /dev/loop-windisk-begin b 7 991
</span><span class="z-text z-plain">mknod /dev/loop-windisk-end b 7 992
</span></code></pre> <p>然后把两个文件搞上去。</p> <pre class=z-code><code><span class="z-text z-plain">losetup loop-windisk-begin /var/lib/private/windisk-begin.img
</span><span class="z-text z-plain">losetup loop-windisk-end /var/lib/private/windisk-end.img
</span></code></pre><li><p>几个设备的扇区数得算一下，可以lsblk --bytes，然后除以512就是了。</p> <p>比如我的$hit是787879936个扇区，loop-windisk-begin是256MiB所以是524288，loop-windisk-end是64MiB所以是131072。</p> <p>等下要把这三个按顺序粘一块，放的位置也得算一下。</p><li><p>写个windisk.dm，格式参考dmsetup(8)的TABLE FORMAT节。我写的长这样：</p> <pre class=z-code><code><span class="z-text z-plain">0 524288 linear /dev/loop-windisk-begin 0
</span><span class="z-text z-plain">524288 787879936 linear /dev/disk/by-uuid/122831BB28319EA3 0
</span><span class="z-text z-plain">788404224 131072 linear /dev/loop-windisk-end 0
</span></code></pre><li><p>然后就可以粘了。</p> <pre class=z-code><code><span class="z-text z-plain">dmsetup create windisk /var/lib/private/windisk.dm
</span></code></pre> <p>然后应该就有了个<code>/dev/mapper/windisk</code>。</p><li><p>修分区表。一般testdisk能找出来，跟着提示操作，确认一下找出来的位置长度对不对就行了。</p> <p>喜欢挑战或者testdisk没找出来，就手动搞吧，反正上面那些数字你都有了。</p> <p>efi分区不用自己建，等下修引导的时候自动搞。</p><li><p>修引导。</p> <p>我本来因为不想搞安装盘，寻思直接把物理盘的efi分区拷进去，但是windows boot manager导不起来。我估计是BCD不对，但是也没找到能在linux里改BCD的工具。我想用grub，但是网上的资料全都是chainload windows boot manager，没找到什么可以直接引导windows内核的办法。我记得我物理盘里还留着个恢复分区，一顿dm+fdisk，无果。我想找个PE但是好像都得在Windows上装，这时候正上课呢还没网。然后发现坐我旁边的舍友随身带着个安装盘。</p> <p>把<code>/dev/mapper/windisk</code>和安装盘挂虚拟机里，从安装盘启动，看到“修复计算机”的时候点进去。它应该是不会修的，但是我们只需要找疑难解答然后找命令提示符。我记得Shift+F10还是啥可以直接开的来着？ 先确认一下你的$hit分区是哪个盘，我的成了D盘。然后只要：</p> <pre class=z-code><code><span class="z-text z-plain">bcdboot D:\Windows
</span></code></pre> <p>就好了。</p><li><p>拔安装盘，重启，如果引导正常，应该会开始正在准备设备，等几分钟一般就好了。</p><li><p>上面5-8那些操作我写到了个脚本里，我觉得应该能有udev之类的更优雅的搞法，但是先不管了。</p></ol></article></div></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://www.getzola.org/>Zola</a> and <a href=https://github.com/aaranxu/adidoks>AdiDoks</a></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script defer src=https://e792a8.github.io/js/main.js></script><script defer src=https://e792a8.github.io/plugins/elasticlunr.min.js></script><script defer src=https://e792a8.github.io/search_index.zh.js></script><script defer src=https://e792a8.github.io/js/search.js></script>